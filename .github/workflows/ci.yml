name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

  spm-build-test:
    name: SPM Build & Test (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Cache SPM build
        uses: actions/cache@v4.2.2
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve
        run: |
          set -euo pipefail
          swift package resolve

      - name: Build (Release)
        run: |
          set -euo pipefail
          swift build -c release

      - name: Test
        run: |
          set -euo pipefail
          swift test --parallel --enable-code-coverage

      - name: Export coverage (best-effort)
        if: always()
        run: |
          set -euo pipefail
          BIN_PATH="$(swift build --show-bin-path)"
          TEST_BIN="$BIN_PATH/PinGuardPackageTests.xctest/Contents/MacOS/PinGuardPackageTests"
          PROF_DATA=".build/debug/codecov/default.profdata"

          if [ -f "$TEST_BIN" ] && [ -f "$PROF_DATA" ]; then
            xcrun llvm-cov export \
              "$TEST_BIN" \
              -instr-profile="$PROF_DATA" \
              -format=lcov > coverage.lcov
          else
            echo "Coverage artifacts not found; skipping export."
          fi

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: spm-code-coverage
          path: coverage.lcov
          if-no-files-found: ignore

  example-app-test:
    name: Example App (iOS Simulator)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Pick an available iPhone simulator (dynamic)
        shell: bash
        run: |
          set -euo pipefail

          UDID="$(python3 - <<'PY'
          import json, subprocess
          data = json.loads(subprocess.check_output(["xcrun","simctl","list","-j","devices","available"]))
          prefs = ["iPhone 16 Pro", "iPhone 16", "iPhone 17 Pro", "iPhone 17"]

          def all_devices():
              for _, devices in data["devices"].items():
                  for d in devices:
                      if d.get("isAvailable"):
                          yield d

          # Prefer known iPhones
          for preferred in prefs:
              for d in all_devices():
                  if d.get("name") == preferred:
                      print(d["udid"])
                      raise SystemExit

          # Fallback: first available iPhone
          for d in all_devices():
              if str(d.get("name","")).startswith("iPhone"):
                  print(d["udid"])
                  raise SystemExit

          raise SystemExit("No available iPhone simulator found")
          PY
          )"

          echo "SIM_DEST=platform=iOS Simulator,id=$UDID" >> "$GITHUB_ENV"
          echo "DEST_KEY=iossim-$UDID" >> "$GITHUB_ENV"

          echo "Chosen UDID: $UDID"
          echo "SIM_DEST: platform=iOS Simulator,id=$UDID"
          echo "DEST_KEY: iossim-$UDID"

      - name: Cache Example SPM
        uses: actions/cache@v4.2.2
        with:
          path: Example/.build
          key: ${{ runner.os }}-example-${{ env.DEST_KEY }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-example-${{ env.DEST_KEY }}-
            ${{ runner.os }}-example-

      - name: Resolve packages (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies \
            -project Example.xcodeproj \
            -scheme Example

      - name: Build (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild build \
            -project Example.xcodeproj \
            -scheme Example \
            -destination "${{ env.SIM_DEST }}" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee build.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: example-logs
          path: |
            Example/build.log
            Example/test.log
          if-no-files-found: ignore

  validate-distribution:
    name: Validate SPM Distribution (macOS + iOS sim)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Validate Package.swift
        run: |
          set -euo pipefail
          swift package dump-package > /dev/null
          echo "✅ Package.swift OK"

      - name: Build for iOS Simulator (SPM cross-build)
        run: |
          set -euo pipefail

          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            TRIPLE="arm64-apple-ios15.0-simulator"
          else
            TRIPLE="x86_64-apple-ios15.0-simulator"
          fi

          SDKROOT="$(xcrun --sdk iphonesimulator --show-sdk-path)"
          swift build -c release --sdk "$SDKROOT" --triple "$TRIPLE"

      - name: Validate integration via local path dependency
        run: |
          set -euo pipefail

          TEMP_DIR="$(mktemp -d)"
          cd "$TEMP_DIR"

          cat > Package.swift << 'EOF'
          // swift-tools-version: 5.9
          import PackageDescription

          let package = Package(
              name: "TestIntegration",
              platforms: [
                  .iOS(.v15),
                  .macOS(.v12)
              ],
              dependencies: [
                  .package(name: "pinguard-ios", path: "__WORKSPACE__")
              ],
              targets: [
                  .target(
                      name: "TestIntegration",
                      dependencies: [
                          .product(name: "PinGuard", package: "pinguard-ios")
                      ]
                  )
              ]
          )
          EOF

          sed -i '' "s|__WORKSPACE__|$GITHUB_WORKSPACE|g" Package.swift

          mkdir -p Sources/TestIntegration
          cat > Sources/TestIntegration/Test.swift << 'EOF'
          import PinGuard
          public func testImport() { print("PinGuard import OK") }
          EOF

          swift package resolve
          swift build
          echo "✅ Integration OK"

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - lint
      - spm-build-test
      - example-app-test
      - validate-distribution
    if: always()
    steps:
      - name: Ensure all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.spm-build-test.result }}" != "success" ] || \
             [ "${{ needs.example-app-test.result }}" != "success" ] || \
             [ "${{ needs.validate-distribution.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI jobs passed"
