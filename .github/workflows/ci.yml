name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

  spm-build-test:
    name: SPM Build & Test (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Cache SPM build
        uses: actions/cache@v4.2.2
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve
        run: |
          set -euo pipefail
          swift package resolve

      - name: Build (Release)
        run: |
          set -euo pipefail
          swift build -c release

      - name: Test
        run: |
          set -euo pipefail
          swift test --parallel --enable-code-coverage

      - name: Export coverage (best-effort)
        if: always()
        run: |
          set -euo pipefail
          BIN_PATH="$(swift build --show-bin-path)"
          TEST_BIN="$BIN_PATH/PinGuardPackageTests.xctest/Contents/MacOS/PinGuardPackageTests"
          PROF_DATA=".build/debug/codecov/default.profdata"

          if [ -f "$TEST_BIN" ] && [ -f "$PROF_DATA" ]; then
            xcrun llvm-cov export \
              "$TEST_BIN" \
              -instr-profile="$PROF_DATA" \
              -format=lcov > coverage.lcov
          else
            echo "Coverage artifacts not found; skipping export."
          fi

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: spm-code-coverage
          path: coverage.lcov
          if-no-files-found: ignore

  example-app-test:
    name: Example App (iOS Simulator)
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        destination:
          - platform=iOS Simulator,name=iPhone 15 Pro
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Sanitize destination for cache key
        shell: bash
        run: |
          set -euo pipefail
          # "platform=iOS Simulator,name=iPhone 15 Pro" -> "platform=iOS_Simulator-name=iPhone_15_Pro"
          DEST_KEY="$(echo '${{ matrix.destination }}' | tr ', ' '-_')"
          echo "DEST_KEY=$DEST_KEY" >> "$GITHUB_ENV"
          echo "DEST_KEY=$DEST_KEY"

      - name: Cache Example SPM
        uses: actions/cache@v4.2.2
        with:
          path: Example/.build
          key: ${{ runner.os }}-example-${{ env.DEST_KEY }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-example-${{ env.DEST_KEY }}-
            ${{ runner.os }}-example-

      - name: Resolve packages (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies \
            -project Example.xcodeproj \
            -scheme Example

      - name: Build (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild build \
            -project Example.xcodeproj \
            -scheme Example \
            -destination "${{ matrix.destination }}" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee build.log

      - name: Test (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild test \
            -project Example.xcodeproj \
            -scheme Example \
            -destination "${{ matrix.destination }}" \
            -configuration Debug \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee test.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: example-logs-${{ strategy.job-index }}
          path: |
            Example/build.log
            Example/test.log
          if-no-files-found: ignore

  validate-distribution:
    name: Validate SPM Distribution (macOS + iOS sim)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Validate Package.swift
        run: |
          set -euo pipefail
          swift package dump-package > /dev/null
          echo "✅ Package.swift OK"

      - name: Build for macOS (tests included)
        run: |
          set -euo pipefail
          swift build --build-tests -c release

      - name: Build for iOS Simulator (SPM cross-build)
        run: |
          set -euo pipefail

          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            TRIPLE="arm64-apple-ios15.0-simulator"
          else
            TRIPLE="x86_64-apple-ios15.0-simulator"
          fi

          SDKROOT="$(xcrun --sdk iphonesimulator --show-sdk-path)"
          swift build -c release --sdk "$SDKROOT" --triple "$TRIPLE"

      - name: Validate integration via local path dependency
        run: |
          set -euo pipefail

          TEMP_DIR="$(mktemp -d)"
          cd "$TEMP_DIR"

          cat > Package.swift << 'EOF'
          // swift-tools-version: 5.9
          import PackageDescription

          let package = Package(
              name: "TestIntegration",
              platforms: [.iOS(.v15)],
              dependencies: [
                  .package(path: "__WORKSPACE__")
              ],
              targets: [
                  .target(
                      name: "TestIntegration",
                      dependencies: ["PinGuard"]
                  )
              ]
          )
          EOF

          sed -i '' "s|__WORKSPACE__|$GITHUB_WORKSPACE|g" Package.swift

          mkdir -p Sources/TestIntegration
          cat > Sources/TestIntegration/Test.swift << 'EOF'
          import PinGuard
          public func testImport() { print("PinGuard import OK") }
          EOF

          swift package resolve
          swift build
          echo "✅ Integration OK"

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - lint
      - spm-build-test
      - example-app-test
      - validate-distribution
    if: always()
    steps:
      - name: Ensure all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.spm-build-test.result }}" != "success" ] || \
             [ "${{ needs.example-app-test.result }}" != "success" ] || \
             [ "${{ needs.validate-distribution.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI jobs passed"
