name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: nightly-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      - name: Install SwiftLint
        run: brew install swiftlint
      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

  spm-build-test:
    name: SPM Build & Test (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode (default)
        run: |
          set -euo pipefail
          sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | sort | tail -n 1)/Contents/Developer"
          xcodebuild -version

      - name: Cache SPM build
        uses: actions/cache@v4.2.2
        with:
          path: .build
          key: ${{ runner.os }}-spm-nightly-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-nightly-
            ${{ runner.os }}-spm-

      - name: Resolve
        run: |
          set -euo pipefail
          swift package resolve

      - name: Build (Release)
        run: |
          set -euo pipefail
          swift build -c release

      - name: Test
        run: |
          set -euo pipefail
          swift test --parallel --enable-code-coverage

  example-app-test:
    name: Example App (Nightly matrix)
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        deviceName:
          - iPhone 16
          - iPhone 16 Pro
          - iPad Pro 13-inch (M4)
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode (default)
        run: |
          set -euo pipefail
          sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | sort | tail -n 1)/Contents/Developer"
          xcodebuild -version

      - name: List available simulators (short)
        run: xcrun simctl list devices available | egrep "iPhone|iPad" | head -n 200

      - name: Sanitize device name for cache key
        id: dest
        run: |
          set -euo pipefail
          raw='${{ matrix.deviceName }}'
          safe="$(echo "$raw" \
            | tr ', ' '__' \
            | tr '=/()' '-----' \
            | tr -cd 'A-Za-z0-9_.-')"
          echo "safe=$safe" >> "$GITHUB_OUTPUT"

      - name: Cache Example build artifacts
        uses: actions/cache@v4.2.2
        with:
          path: |
            Example/.build
            Example/.derivedData
          key: ${{ runner.os }}-example-nightly-${{ steps.dest.outputs.safe }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-example-nightly-${{ steps.dest.outputs.safe }}-
            ${{ runner.os }}-example-nightly-

      - name: Resolve packages (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies \
            -project Example.xcodeproj \
            -scheme Example \
            -clonedSourcePackagesDirPath .build \
            -derivedDataPath .derivedData

      - name: Resolve simulator UDID
        id: sim
        run: |
          set -euo pipefail
          NAME='${{ matrix.deviceName }}'

          python3 - "$NAME" <<'PY' > /tmp/udid.txt
          import json, subprocess, sys

          name = sys.argv[1]
          out = subprocess.check_output(
              ["xcrun", "simctl", "list", "devices", "available", "-j"],
              text=True
          )
          data = json.loads(out)

          for runtime, devices in data.get("devices", {}).items():
              for d in devices:
                  if d.get("name") == name and d.get("isAvailable", False):
                      print(d.get("udid", ""))
                      raise SystemExit(0)

          raise SystemExit(1)
          PY

          if [ ! -s /tmp/udid.txt ]; then
            echo "‚ùå Simulator not found: $NAME"
            xcrun simctl list devices available
            exit 1
          fi

          UDID="$(cat /tmp/udid.txt)"
          echo "udid=$UDID" >> "$GITHUB_OUTPUT"

      - name: Test (Example)
        working-directory: Example
        run: |
          set -euo pipefail
          xcodebuild test \
            -project Example.xcodeproj \
            -scheme Example \
            -destination "id=${{ steps.sim.outputs.udid }}" \
            -configuration Release \
            -enableCodeCoverage YES \
            -clonedSourcePackagesDirPath .build \
            -derivedDataPath .derivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee test.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4.5.0
        with:
          name: nightly-example-logs-${{ strategy.job-index }}
          path: Example/test.log
          if-no-files-found: ignore

  validate-distribution:
    name: Validate Distribution
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Select Xcode (default)
        run: |
          set -euo pipefail
          sudo xcode-select -s "$(ls -d /Applications/Xcode*.app | sort | tail -n 1)/Contents/Developer"
          xcodebuild -version

      - name: Validate Package.swift
        run: |
          set -euo pipefail
          swift package dump-package > /dev/null

      - name: Build macOS + iOS Simulator
        run: |
          set -euo pipefail

          # Build library for macOS (Release)
          swift build -c release

          # Build library for iOS Simulator (Release)
          ARCH="$(uname -m)"
          if [ "$ARCH" = "arm64" ]; then
            TRIPLE="arm64-apple-ios15.0-simulator"
          else
            TRIPLE="x86_64-apple-ios15.0-simulator"
          fi

          SDKROOT="$(xcrun --sdk iphonesimulator --show-sdk-path)"
          swift build -c release --sdk "$SDKROOT" --triple "$TRIPLE"

  extended-validation:
    name: Extended Validation
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Show dependencies
        run: |
          set -euo pipefail
          swift package show-dependencies

      - name: Code statistics (best-effort)
        run: |
          set -euo pipefail
          echo "üìä Code Statistics:"
          echo "Total Swift files: $(find Sources Tests -name '*.swift' 2>/dev/null | wc -l || true)"
          echo "Total lines: $(find Sources Tests -name '*.swift' -exec cat {} \; 2>/dev/null | wc -l || true)"

      - name: README basic link sanity
        run: |
          set -euo pipefail
          if grep -E '\]\(\s*\)' README.md; then
            echo "‚ùå Found empty link in README"
            exit 1
          fi
          echo "‚úÖ README link sanity OK"

  notify-on-failure:
    name: Notify on Failure (scheduled only)
    runs-on: ubuntu-latest
    needs:
      - lint
      - spm-build-test
      - example-app-test
      - validate-distribution
      - extended-validation
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue if none open
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            // Avoid spamming: create only if no open issue exists
            const q = `repo:${owner}/${repo} is:issue is:open in:title "Nightly Build Failed"`;
            const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 1 });
            if (res.data.items.length > 0) {
              core.info('An open nightly failure issue already exists. Skipping creation.');
              return;
            }

            const body = [
              '## Nightly Build Failure',
              '',
              'Scheduled nightly build failed.',
              '',
              `- Run: ${runUrl}`,
              `- Date: ${new Date().toISOString().split('T')[0]}`,
              '',
              'Next:',
              '1) Check logs',
              '2) Fix root cause',
              '3) Close this issue'
            ].join('\n');

            await github.rest.issues.create({
              owner, repo,
              title: 'üî¥ Nightly Build Failed',
              body
            });

  nightly-success:
    name: Nightly Success
    runs-on: ubuntu-latest
    needs:
      - lint
      - spm-build-test
      - example-app-test
      - validate-distribution
      - extended-validation
    if: always()
    steps:
      - name: Ensure all jobs succeeded
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.spm-build-test.result }}" != "success" ] || \
             [ "${{ needs.example-app-test.result }}" != "success" ] || \
             [ "${{ needs.validate-distribution.result }}" != "success" ] || \
             [ "${{ needs.extended-validation.result }}" != "success" ]; then
            echo "‚ùå Nightly failed"
            exit 1
          fi
          echo "‚úÖ Nightly passed"
